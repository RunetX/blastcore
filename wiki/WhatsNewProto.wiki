#summary Микропротокол проверки обновлений - запроса изменений в версиях Blastcore.

= Цель, частота и настройки =

Юзеры не имеют привычки самостоятельно обновлять софт - им надо об этом явно говорить. При этом для удобства стоит показывать и список изменений - ради чего пользователю обновляться, а также чтобы видели, что программа реально улучшается.

Кроме того, опять же для удобства и устранения недовольства пользователей следует иметь возможность отключить галку автоматической проверки обновлений.

Вопрос частоты проверки обновлений надо бы обсудить. Как минимум, это надо делать при запуске Бласта, но:
  * Неясно, сразу же после коннекта к серверу, или надо подождать некоторое время
  * Нужно ли это при каждом запуске Бласта, или только спустя N дней с предыдущей?
  * Делать ли это несколько раз за запуск, что-нибудь типа счетчика "каждые 100 мессаг" ?

Когда наступило событие, что надо произвести проверку, запускается процедура, алгоритм которой описан ниже.

= Серверная сторона и доступ пользователя =

На основном сервере кладется текстовик и в `inetd.conf` делается запись типа `cat /path/blastcore-whatsnew.txt`. Номер порта любой - на текущий момент таким выбрали 9100. То есть сервер разом выплевывает текстовое содержимое и закрывает сокет.

Файл с изменениями для текущей версии стоит положить в дистрибутив, и, возможно, добавить в меню пункт, открывающий этот текстовик (хоть в "Блокноте"). А может, ограничиться таким пунктом только в инсталляторе. Кроме того, неплохо бы добавить в меню еще один пункт, для ручной проверки обновлений.

= Формат файла =

Обыкновенный текстовый. В нём совершенно обычный текст в произвольном формате, предназначенный для чтения человеком (пользователем). Особый формат имеют только строки, выступающие заголовком очередной версии - можно описать как "^version:$", то есть точно с начала строки идёт версия, затем двоеточие, и всё, строка состоит только из этого. После этого для удобочитаемости можно добавить пустую строку (алгоритму пофиг). Порядок записей - свежие в начале. Например:

{{{
BlastCore 0.5 beta:
 * Добавлена новая крутая фича
 * Пофикшен мерзкий баг

BlastCore 0.4:
 * Пофикшена работа с Ctrl-стрелками в окне набора нового сообщения
 * Прикручены автообновления

BlastCore 0.3 RC1:
 * Есть скины

Более старые версии:
 * никто уже не помнит, что когда было 
 * и всё равно алгоритм это не покажет, так что тут формат секции произволен

Самый свежак всегда доступен по адресу:
http://a.long-long.time.ago/in/a/galaxy/far/far/away
}}}

= Алгоритм процедуры проверки в Бласте =

Предварительно должны быть выполнены условия:

  * Успешно соединились с главным сервером
  * Есть строка собственной версии, например "BlastCore 0.21 beta" или "BlastCore 0.4"

Затем собственно работаем, причем в случае любой ошибки молча прекращаем (ну разве что в дебаг-консоль), юзеру что-то должно показаться лишь в одном случае - есть новая версия:

  # Создаем сокет и коннектим его на адрес основного сервера и определенный выше порт
  # Готовим строку-маркер: строка собственной версии плюс двоеточие
  # Читаем из сокета по одной строке в цикле - там текстовые данные
  # Очередную прочтенную строку сравниваем со строкой-маркером
  # Если не равно, то запоминаем строку в списке строк
  # Если равно, то файл прочитан до позиции нашей собственной версии, дальше нет нового
  # Если список запомненных строк не пуст, значит, в файле есть новое перед строкой с нашей версией, показываем окно с просьбой обновиться и запомненным текстом юзеру.

= Изменения в сентябре 2010 =

 * Изменили строки с "0.4:" на "BlastCore 0.4:"
 * Теперь самая последняя строка (вся целиком) Бластом считается URL для показа пользователю, откуда скачать (так что в ней должен быть только URL с начала строки, больше ничего).
 * На текущий момент Бласт проверяет обновления только при запуске. Порт 9100.